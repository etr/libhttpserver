platform: x64

environment:
  matrix:
    - compiler: mingw64
      MINGW_CHOST: x86_64-w64-mingw32
      MSYS2_ARCH: x86_64
      MSYS2_SHELL: mingw64
      APPVEYOR_BUILD_WORKER_IMAGE: Visual Studio 2019
    - compiler: msys
      MINGW_CHOST: x86_64-pc-msys
      MSYS2_ARCH: x86_64
      MSYS2_SHELL: msys
      APPVEYOR_BUILD_WORKER_IMAGE: Visual Studio 2019
init:
  - 'echo Building libhttpserver %version% for Windows'
  - 'echo System architecture: %PLATFORM%'
  - 'echo Repo build branch is: %APPVEYOR_REPO_BRANCH%'
  - 'echo Build folder is: %APPVEYOR_BUILD_FOLDER%'
  - 'echo Repo build commit is: %APPVEYOR_REPO_COMMIT%'
  - 'echo Cygwin root is: %CYG_ROOT%'
  - ps: iex ((new-object net.webclient).DownloadString('https://raw.githubusercontent.com/appveyor/ci/master/scripts/enable-rdp.ps1'))
install:
  # Install packages (use msys2 shell for package management)
  - 'C:\msys64\msys2_shell.cmd -defterm -no-start -msys2 -c "pacman --noconfirm -S --needed mingw-w64-$MSYS2_ARCH-{libtool,make,pkg-config,libsystre,doxygen,gnutls,graphviz,curl}"'
  - 'C:\msys64\msys2_shell.cmd -defterm -no-start -msys2 -c "pacman --noconfirm -S --needed autotools"'
  # For msys shell, also install msys-specific packages
  - 'if "%compiler%"=="msys" C:\msys64\msys2_shell.cmd -defterm -no-start -msys2 -c "pacman --noconfirm -S --needed msys2-devel gcc make curl"'
  # Download and build libmicrohttpd
  - 'C:\msys64\msys2_shell.cmd -defterm -no-start -%MSYS2_SHELL% -full-path -here -c "cd $APPVEYOR_BUILD_FOLDER && curl https://s3.amazonaws.com/libhttpserver/libmicrohttpd_releases/libmicrohttpd-0.9.64.tar.gz -o libmicrohttpd-0.9.64.tar.gz"'
  - 'C:\msys64\msys2_shell.cmd -defterm -no-start -%MSYS2_SHELL% -full-path -here -c "cd $APPVEYOR_BUILD_FOLDER && tar -xzf libmicrohttpd-0.9.64.tar.gz"'
  - 'C:\msys64\msys2_shell.cmd -defterm -no-start -%MSYS2_SHELL% -full-path -here -c "cd $APPVEYOR_BUILD_FOLDER/libmicrohttpd-0.9.64 && ./configure --disable-examples --enable-poll=no --prefix /C/msys64 && make && make install"'
  # Bootstrap and configure libhttpserver
  - 'C:\msys64\msys2_shell.cmd -defterm -no-start -%MSYS2_SHELL% -full-path -here -c "cd $APPVEYOR_BUILD_FOLDER && ./bootstrap"'
  - 'C:\msys64\msys2_shell.cmd -defterm -no-start -%MSYS2_SHELL% -full-path -here -c "cd $APPVEYOR_BUILD_FOLDER && mkdir build && cd build && MANIFEST_TOOL=no; ../configure --disable-fastopen --prefix /C/msys64 CXXFLAGS=-I/C/msys64/include LDFLAGS=-L/C/msys64/lib; make"'
build_script:
  - 'C:\msys64\msys2_shell.cmd -defterm -no-start -%MSYS2_SHELL% -full-path -here -c "cd $APPVEYOR_BUILD_FOLDER/build && make check"'
  - 'C:\msys64\msys2_shell.cmd -defterm -no-start -%MSYS2_SHELL% -full-path -here -c "cd $APPVEYOR_BUILD_FOLDER/build && cat test/test-suite.log"'
